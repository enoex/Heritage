// Generated by CoffeeScript 1.4.0
(function() {

  define(['components/Vector'], function(Vector) {
    var Physics;
    Physics = (function() {

      function Physics(entities) {
        this.entities = entities;
        return this;
      }

      Physics.prototype.updatePhysics = function(entity) {
        var physics;
        physics = entity.components.physics;
        physics.velocity.add(physics.acceleration);
        physics.velocity.limit(physics.maxSpeed);
        if (entity) {
          entity.components.position.add(physics.velocity);
        }
        physics.acceleration.multiply(0);
        this.checkEdges(entity);
        return this;
      };

      Physics.prototype.checkEdges = function(entity) {
        var physics, position;
        physics = entity.components.physics;
        position = entity.components.position;
        if (position.x >= physics.maxX) {
          position.x = position.x % physics.maxX;
        } else if (position.x < 0) {
          position.x = physics.maxX - 1;
        }
        if (position.y >= physics.maxY) {
          position.y = position.y % physics.maxY;
        } else if (position.y < 0) {
          position.y = physics.maxY - 1;
        }
        return entity;
      };

      Physics.prototype.humanZombieBehavior = function(entity) {
        var behaviorForce, behvaiorForce, neighbor, neighbors, numHumans, numZombies, physics, pursuitDesire, scale, zombie, _i, _j, _len, _len1, _ref;
        physics = entity.components.physics;
        behvaiorForce = new Vector(0, 0);
        if (entity.hasComponent('human') && this.entities.entitiesIndex.zombie) {
          numHumans = numZombies = 0;
          neighbors = [];
          _ref = entity.components.world.getNeighbors(4);
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            neighbor = _ref[_i];
            if (neighbor.hasComponent('zombie')) {
              numZombies += 1;
            }
            if (neighbor.hasComponent('human')) {
              numHumans += 1;
            }
            if (neighbor !== entity) {
              neighbors.push(neighbor);
            }
          }
          pursuitDesire = 0;
          if (entity.components.health.health < 20) {
            pursuitDesire -= 2;
          }
          if (entity.components.human.age < 10 || entity.components.human.age > 80) {
            pursuitDesire -= 4;
          }
          for (_j = 0, _len1 = neighbors.length; _j < _len1; _j++) {
            neighbor = neighbors[_j];
            if (neighbor.hasComponent('zombie')) {
              zombie = neighbor;
              scale = (numHumans / 2.5) - numZombies;
              if (scale > 1) {
                scale = 1;
              } else if (scale < -5) {
                scale = -5;
              }
              behaviorForce = physics.seekForce(zombie).multiply(scale);
              physics.applyForce(behaviorForce);
            }
          }
          return behaviorForce;
        }
      };

      Physics.prototype.tick = function(delta) {
        var child, childId, entity, human, id, mateId, physics, _i, _len, _ref, _ref1, _results;
        _ref = this.entities.entitiesIndex['physics'];
        _results = [];
        for (id in _ref) {
          entity = _ref[id];
          physics = entity.components.physics;
          if (entity.hasComponent('randomWalker')) {
            physics.applyForce(entity.components.randomWalker.walkForce());
          }
          if (entity.hasComponent('flocking')) {
            if (entity.hasComponent('human')) {
              entity.components.flocking.flock(this.entities.entitiesIndex.human);
            }
            if (entity.hasComponent('zombie')) {
              entity.components.flocking.flock(this.entities.entitiesIndex.zombie, 0.7);
            }
          }
          if (entity.hasComponent('human')) {
            this.humanZombieBehavior(entity);
          }
          if (entity.hasComponent('human')) {
            human = entity.components.human;
            mateId = human.mateId;
            if (mateId !== null) {
              if (this.entities.entities[mateId]) {
                physics.applyForce(physics.seekForce(this.entities.entities[mateId]).multiply(2));
              }
            }
            if (human.children.length > 0) {
              _ref1 = human.children;
              for (_i = 0, _len = _ref1.length; _i < _len; _i++) {
                childId = _ref1[_i];
                child = this.entities.entities[childId];
                if (child && child.components.human.age < 18) {
                  physics.applyForce(physics.seekForce(child).multiply(2.5));
                }
              }
            }
          }
          _results.push(this.updatePhysics(entity));
        }
        return _results;
      };

      return Physics;

    })();
    return Physics;
  });

}).call(this);
